<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>PayPal App Switch Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
      color: #1e293b;
      line-height: 1.6;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: #ffffff;
      border-radius: 16px;
      padding: 32px 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      border: 1px solid #e2e8f0;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .header p {
      color: #64748b;
      font-size: 16px;
    }

    .payment-section {
      margin-bottom: 24px;
    }

    #paypal-button-container {
      margin: 24px 0;
    }

    #status {
      padding: 16px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      margin: 16px 0;
      transition: all 0.3s ease;
    }

    #status.success {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #15803d;
    }

    #status.error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #dc2626;
    }

    #status.processing {
      background: #fffbeb;
      border-color: #fed7aa;
      color: #d97706;
    }

    #retry-btn {
      display: none;
      width: 100%;
      background: #3b82f6;
      border: none;
      color: white;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s ease;
    }

    #retry-btn:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    #retry-btn.visible {
      display: block;
    }

    .note {
      margin-top: 24px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      font-size: 14px;
      color: #475569;
      line-height: 1.5;
    }

    .note-icon {
      font-size: 18px;
      margin-bottom: 8px;
      display: block;
    }

    .note-list {
      margin: 8px 0 0 0;
      list-style: none;
    }

    .note-list li {
      margin: 4px 0;
      padding-left: 16px;
      position: relative;
    }

    .note-list li:before {
      content: "â€¢";
      color: #3b82f6;
      font-weight: bold;
      position: absolute;
      left: 0;
    }

    #debug {
      margin-top: 16px;
      font-size: 12px;
      color: #64748b;
      background: #f1f5f9;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    #debug pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .creator {
      margin-top: 32px;
      font-size: 13px;
      color: #94a3b8;
      text-align: center;
    }

    /* Mobile optimizations */
    @media (max-width: 480px) {
      body {
        padding: 12px;
      }
      
      .container {
        padding: 24px 20px;
        border-radius: 12px;
      }
      
      .header h1 {
        font-size: 22px;
      }
      
      .header p {
        font-size: 15px;
      }
    }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <!-- PayPal JavaScript SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=Ac1vORyWNh9SXRQeEb-ZP7KfzHIBjeqsJYviC05nFZ7AcWfLdqomPL2jpiBbEdVfiRxprb8BcrRhGYh2&currency=USD&intent=capture&enable-funding=paypal&disable-funding=credit,card"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>PayPal App Switch</h1>
      <p>Mobile Payment Demo</p>
    </div>
    
    <div class="payment-section">
      <div id="paypal-button-container"></div>
      <div id="status">Ready to pay</div>
      <button id="retry-btn">Try Another Payment</button>
    </div>
    
    <div class="note">
      <span class="note-icon">ðŸ“±</span>
      <strong>Testing Instructions:</strong>
      <ul class="note-list">
        <li>Install PayPal Sandbox App</li>
        <li>Use US PayPal Sandbox account</li>
        <li>Test on mobile device</li>
      </ul>
    </div>

    <div id="debug"></div>

    <div class="creator">
      Demo by Alejandro Frutos
    </div>
  </div>

  <script>
    const statusDiv = document.getElementById("status");
    const debugDiv = document.getElementById("debug");
    const retryBtn = document.getElementById("retry-btn");

    function setStatus(msg, type = 'default') {
      statusDiv.textContent = msg;
      statusDiv.className = type;
      console.log(msg);
    }
    
    function setDebug(obj) {
      debugDiv.innerHTML = '<pre>' + JSON.stringify(obj, null, 2) + '</pre>';
    }
    
    function showRetryButton() {
      retryBtn.classList.add("visible");
    }

    function resetUI() {
      retryBtn.classList.remove("visible");
      setStatus("Ready to pay");
      setDebug({});
      // Re-render PayPal buttons
      renderPayPalButtons();
    }

    retryBtn.addEventListener("click", () => {
      resetUI();
    });

    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) return "Android";
      if (/iPad|iPhone|iPod/.test(ua)) return "iOS";
      if (/Windows/.test(ua)) return "Windows";
      if (/Macintosh/.test(ua)) return "Mac";
      return "Other";
    }

    function parseHashParams(hash) {
      const params = {};
      // Handle both #return?token=... and #token=... formats
      const paramString = hash.includes('?') ? hash.split('?')[1] : hash.substring(1);
      paramString.split("&").forEach(kv => {
        const [key, value] = kv.split("=");
        if (key && value) {  // Only add if both key and value exist
          params[key] = decodeURIComponent(value);
        }
      });
      return params;
    }

    function renderPayPalButtons() {
      // Clear existing buttons
      document.getElementById('paypal-button-container').innerHTML = '';
      
      // For App Switch, we need to create the order server-side and redirect manually
      // rather than using SDK's createOrder callback
      paypal.Buttons({
        style: {
          layout: 'vertical',
          color: 'yellow',
          shape: 'rect',
          label: 'paypal',
          height: 55
        },
        
        onClick: async function(data, actions) {
          // Create order server-side for app switch
          setStatus("Creating order...", 'processing');
          setDebug({ device: getDeviceType(), userAgent: navigator.userAgent });
          
          try {
            const response = await fetch("/api/create-order", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ 
                cart: { amount: "10.00" } 
              })
            });
            
            const order = await response.json();
            setDebug({ 
              device: getDeviceType(), 
              userAgent: navigator.userAgent, 
              order: order 
            });
            
            if (!response.ok) {
              throw new Error(order.error || 'Failed to create order');
            }
            
            // Store order ID for checking status later
            if (order.id) {
              sessionStorage.setItem('pendingOrder', order.id);
            }
            
            // Check if app switch is eligible
            if (order.payment_source?.paypal?.app_switch_eligibility) {
              // Find the approval URL for app switch
              const approvalUrl = order.links?.find(link => link.rel === "payer-action")?.href;
              if (approvalUrl) {
                setStatus("Redirecting to PayPal app...", 'processing');
                // Redirect to PayPal (this will attempt app switch)
                window.location.href = approvalUrl;
                return false; // Prevent SDK from handling
              }
            }
            
            // Fallback: let SDK handle if app switch not eligible
            return order.id;
          } catch (error) {
            setStatus("Order creation failed", 'error');
            setDebug({ error: error.message });
            console.error('Order creation error:', error);
            return false; // Prevent SDK from continuing
          }
        },
        
        createOrder: function(data, actions) {
          // This won't be called when we handle onClick above
          // But keeping it as fallback
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: '10.00'
              }
            }]
          });
        },
        
        onApprove: async function(data, actions) {
          setStatus("Processing payment...", 'processing');
          
          try {
            const response = await fetch("/api/capture-order", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ orderID: data.orderID })
            });
            
            const capture = await response.json();
            setDebug({ 
              event: 'onApprove_capture',
              device: getDeviceType(), 
              userAgent: navigator.userAgent, 
              orderID: data.orderID,
              capture: capture,
              status: response.status
            });
            
            if (response.ok && capture.status === "COMPLETED") {
              setStatus("Payment completed!", 'success');
              sessionStorage.removeItem('pendingOrder');
              showRetryButton();
            } else {
              setStatus(`Payment failed: ${capture.error || 'Unknown error'}`, 'error');
              console.error("Capture failed:", capture);
              showRetryButton();
            }
          } catch (error) {
            setStatus("Payment processing failed", 'error');
            console.error("Capture error:", error);
            setDebug({ 
              event: 'onApprove_error',
              error: error.message,
              device: getDeviceType(),
              userAgent: navigator.userAgent,
              orderID: data.orderID
            });
            showRetryButton();
          }
        },
        
        onCancel: function(data) {
          setStatus("Payment canceled", 'error');
          sessionStorage.removeItem('pendingOrder');
          setDebug({ 
            event: 'onCancel',
            device: getDeviceType(), 
            userAgent: navigator.userAgent, 
            orderID: data.orderID 
          });
          showRetryButton();
        },
        
        onError: function(err) {
          setStatus("Payment error occurred", 'error');
          console.error('PayPal error:', err);
          setDebug({ 
            event: 'onError',
            error: err.toString(),
            device: getDeviceType(),
            userAgent: navigator.userAgent
          });
          showRetryButton();
        }
      }).render('#paypal-button-container');
    }

    // Handle hash changes for AUTO return flow (App Switch)
    window.addEventListener("hashchange", async (e) => {
      const params = parseHashParams(window.location.hash);
      setDebug({ event: 'hashchange', params });
      
      if (params.token) {
        setStatus("Capturing payment...", 'processing');
        try {
          const res = await fetch("/api/capture-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderID: params.token })
          });
          const capture = await res.json();
          setDebug({ 
            event: 'hashchange_capture',
            device: getDeviceType(), 
            userAgent: navigator.userAgent, 
            params, 
            capture,
            status: res.status
          });
          
          if (res.ok && capture.status === "COMPLETED") {
            setStatus("Payment completed!", 'success');
            sessionStorage.removeItem('pendingOrder');
            showRetryButton();
          } else {
            setStatus(`Payment capture failed: ${capture.error || 'Unknown error'}`, 'error');
            console.error("Capture failed:", capture);
            showRetryButton();
          }
        } catch (err) {
          setStatus("Payment capture failed", 'error');
          console.error("Capture error:", err);
          setDebug({ 
            event: 'hashchange_error',
            error: err.message,
            device: getDeviceType(),
            userAgent: navigator.userAgent,
            params
          });
          showRetryButton();
        }
      } else if (params.canceled !== undefined) {
        setStatus("Payment canceled by user", 'error');
        sessionStorage.removeItem('pendingOrder');
        setDebug({ 
          event: 'payment_canceled_hash',
          device: getDeviceType(), 
          userAgent: navigator.userAgent, 
          params 
        });
        showRetryButton();
      }
    });

    // Handle visibility changes for MANUAL return flow and abandoned checkouts
    document.addEventListener('visibilitychange', async (e) => {
      if (!document.hidden) {
        setDebug({ event: 'visibilitychange', visible: true });
        // Check if we have a pending order to check
        const pendingOrder = sessionStorage.getItem('pendingOrder');
        if (pendingOrder) {
          setStatus("Checking order status...", 'processing');
          try {
            const res = await fetch("/api/capture-order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ orderID: pendingOrder })
            });
            const capture = await res.json();
            setDebug({ event: 'visibilitychange_check', pendingOrder, capture });
            
            if (res.ok && capture.status === "COMPLETED") {
              setStatus("Payment completed!", 'success');
              sessionStorage.removeItem('pendingOrder');
              showRetryButton();
            } else if (capture.error) {
              setStatus("Payment not completed. You can try again.", 'error');
              sessionStorage.removeItem('pendingOrder');
              showRetryButton();
            }
          } catch (error) {
            console.error('Visibility check error:', error);
            setStatus("Ready to pay");
          }
        }
      }
    });

    // Initial load handling for App Switch return
    window.addEventListener("load", async () => {
      const params = parseHashParams(window.location.hash);
      setDebug({ event: 'load', params, hash: window.location.hash });
      
      if (params.token) {
        // Clean up the URL by removing the hash
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        setStatus("Capturing payment...", 'processing');
        try {
          const res = await fetch("/api/capture-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderID: params.token })
          });
          const capture = await res.json();
          setDebug({ 
            event: 'initial_load_capture',
            device: getDeviceType(), 
            userAgent: navigator.userAgent, 
            params, 
            capture,
            status: res.status
          });
          
          if (res.ok && capture.status === "COMPLETED") {
            setStatus("Payment completed!", 'success');
            sessionStorage.removeItem('pendingOrder');
            showRetryButton();
          } else {
            setStatus(`Payment capture failed: ${capture.error || 'Unknown error'}`, 'error');
            console.error("Capture failed:", capture);
            showRetryButton();
          }
        } catch (err) {
          setStatus("Payment capture failed", 'error');
          console.error("Capture error:", err);
          setDebug({ 
            event: 'initial_load_error',
            error: err.message,
            device: getDeviceType(),
            userAgent: navigator.userAgent,
            params
          });
          showRetryButton();
        }
      } else if (params.canceled !== undefined) {
        setStatus("Payment canceled", 'error');
        // Clean up the URL
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        setDebug({ 
          event: 'initial_load_canceled', 
          device: getDeviceType(), 
          userAgent: navigator.userAgent, 
          params 
        });
        showRetryButton();
      }
      
      // Render PayPal buttons after handling any return flow
      setTimeout(() => {
        if (typeof paypal !== 'undefined') {
          renderPayPalButtons();
        } else {
          setStatus("PayPal SDK not loaded", 'error');
        }
      }, 100);
    });
  </script>
</body>
</html>
