<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>PayPal App Switch Demo</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 40px; }
    h2 { color: #333; }
    #paypal-btn {
      background: #ffc439;
      border: none;
      color: #253b80;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: background 0.2s;
    }
    #paypal-btn:hover {
      background: #f4b92e;
    }
    #paypal-logo {
      height: 25px;
      vertical-align: middle;
    }
    .creator {
      margin-top: 40px;
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    .note {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-left: 4px solid #ffc439;
      font-size: 14px;
      color: #666;
      line-height: 1.5;
    }
    #status {
      margin-top: 30px;
      padding: 16px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      color: #222;
      min-height: 40px;
      font-size: 15px;
    }
    #debug {
      margin-top: 16px;
      font-size: 13px;
      color: #666;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 6px;
      word-break: break-all;
    }
    #retry-btn {
      display: none;
      background: #2d9e51;
      border: none;
      color: white;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
      transition: background 0.2s;
    }
    #retry-btn:hover {
      background: #268545;
    }
    #retry-btn.visible {
      display: inline-block;
    }
  </style>
</head>
<body>
  <h2>Pay with PayPal (App Switch)</h2>
  <button id="paypal-btn">
    <img id="paypal-logo" src="https://www.paypalobjects.com/webstatic/mktg/Logo/pp-logo-100px.png" alt="PayPal Logo" />
  </button>
  <div id="status">Ready</div>
  <button id="retry-btn" style="display: none;">Try Another Payment</button>
  <div id="debug"></div>
  
  <div class="note">
    ðŸ“± Important: To test this demo, please:
    <br>1. Download the PayPal Sandbox App
    <br>2. Use a US PayPal Sandbox buyer account
  </div>

  <div class="creator">
    Demo created by Alejandro Frutos
  </div>

  <script>
    const statusDiv = document.getElementById("status");
    const debugDiv = document.getElementById("debug");
    const paypalBtn = document.getElementById("paypal-btn");
    const retryBtn = document.getElementById("retry-btn");

    function setStatus(msg) {
      statusDiv.textContent = msg;
      console.log(msg);
    }
    function setDebug(obj) {
      debugDiv.textContent = JSON.stringify(obj, null, 2);
    }
    
    function showRetryButton() {
      retryBtn.style.display = "inline-block";
      paypalBtn.style.display = "none";
    }

    function resetUI() {
      retryBtn.style.display = "none";
      paypalBtn.style.display = "flex";
      setStatus("Ready");
      setDebug({});
    }

    retryBtn.addEventListener("click", () => {
      resetUI();
    });
    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) return "Android";
      if (/iPad|iPhone|iPod/.test(ua)) return "iOS";
      if (/Windows/.test(ua)) return "Windows";
      if (/Macintosh/.test(ua)) return "Mac";
      return "Other";
    }

    document.getElementById("paypal-btn").addEventListener("click", async () => {
      setStatus("Creating order...");
      setDebug({ device: getDeviceType(), userAgent: navigator.userAgent });
      const res = await fetch("/api/create-order", { method: "POST" });
      const order = await res.json();
      setDebug({ device: getDeviceType(), userAgent: navigator.userAgent, order });
      if (order.links) {
        // Store order ID for checking status later
        if (order.id) {
          sessionStorage.setItem('pendingOrder', order.id);
        }
        const approvalUrl = order.links.find(link => link.rel === "payer-action").href;
        setStatus("Redirecting to PayPal...");
        window.location.href = approvalUrl;
      } else {
        setStatus("Order creation failed");
        setDebug({ error: order });
        console.error(order);
      }
    });

    function parseHashParams(hash) {
      const params = {};
      // Handle both #return?token=... and #token=... formats
      const paramString = hash.includes('?') ? hash.split('?')[1] : hash.substring(1);
      paramString.split("&").forEach(kv => {
        const [key, value] = kv.split("=");
        if (key && value) {  // Only add if both key and value exist
          params[key] = decodeURIComponent(value);
        }
      });
      return params;
    }

    // Handle hash changes for AUTO return flow
    window.addEventListener("hashchange", async (e) => {
      const params = parseHashParams(window.location.hash);
      setDebug({ event: 'hashchange', params });
      
      if (params.token) {
        setStatus("Capturing payment...");
        try {
          const res = await fetch("/api/capture-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderID: params.token })
          });
          const capture = await res.json();
          setDebug({ 
            event: 'capture_response',
            device: getDeviceType(), 
            userAgent: navigator.userAgent, 
            params, 
            capture,
            status: res.status
          });
          
          if (res.ok && capture.status === "COMPLETED") {
            setStatus("Payment completed!");
            sessionStorage.removeItem('pendingOrder');
            showRetryButton();
          } else {
            setStatus(`Payment capture failed: ${capture.error || 'Unknown error'}`);
            console.error("Capture failed:", capture);
          }
        } catch (err) {
          setStatus("Payment capture failed");
          console.error("Capture error:", err);
          setDebug({ 
            event: 'capture_error',
            error: err.message,
            device: getDeviceType(),
            userAgent: navigator.userAgent,
            params
          });
        }
      } else if (params.canceled !== undefined) {
        setStatus("Payment canceled by user");
        sessionStorage.removeItem('pendingOrder');
        setDebug({ 
          event: 'payment_canceled',
          device: getDeviceType(), 
          userAgent: navigator.userAgent, 
          params 
        });
      }
    });

    // Handle visibility changes for MANUAL return flow and abandoned checkouts
    document.addEventListener('visibilitychange', async (e) => {
      if (!document.hidden) {
        setDebug({ event: 'visibilitychange', visible: true });
        // Check if we have a pending order to check
        const pendingOrder = sessionStorage.getItem('pendingOrder');
        if (pendingOrder) {
          setStatus("Checking order status...");
          const res = await fetch("/api/capture-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderID: pendingOrder })
          });
          const capture = await res.json();
          setDebug({ event: 'visibilitychange', pendingOrder, capture });
          if (capture.status === "COMPLETED") {
            setStatus("Payment completed!");
            sessionStorage.removeItem('pendingOrder');
          } else if (capture.error) {
            setStatus("Payment not completed. You can try again.");
            sessionStorage.removeItem('pendingOrder');
          }
        }
      }
    });

    // Initial load handling for App Switch return
    window.addEventListener("load", async () => {
      const params = parseHashParams(window.location.hash);
      setDebug({ event: 'load', params, hash: window.location.hash });
      
      if (params.token) {
        // Clean up the URL by removing the hash
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        setStatus("Capturing payment...");
        try {
          const res = await fetch("/api/capture-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderID: params.token })
          });
          const capture = await res.json();
          setDebug({ 
            event: 'initial_capture',
            device: getDeviceType(), 
            userAgent: navigator.userAgent, 
            params, 
            capture,
            status: res.status
          });
          
          if (res.ok && capture.status === "COMPLETED") {
            setStatus("Payment completed!");
            sessionStorage.removeItem('pendingOrder');
          } else {
            setStatus(`Payment capture failed: ${capture.error || 'Unknown error'}`);
            console.error("Capture failed:", capture);
          }
        } catch (err) {
          setStatus("Payment capture failed");
          console.error("Capture error:", err);
          setDebug({ 
            event: 'initial_capture_error',
            error: err.message,
            device: getDeviceType(),
            userAgent: navigator.userAgent,
            params
          });
        }
      } else if (params.canceled !== undefined) {
        setStatus("Payment canceled");
        // Clean up the URL
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        setDebug({ device: getDeviceType(), userAgent: navigator.userAgent, params });
      }
    });
  </script>
</body>
</html>
